# as root
volife_run.sh -create-user sk "edf123" "sk" "kortas" "EDF " "sk@edf.fr"
volife_run.sh -approve-user sk
volife_run.sh -create-vo test "test" sk
volife_run.sh -list-all-vos | awk '/test/ { gsub(","," "); gsub("gvid","VO");print $4}' >> /home/sk/.bashrc
chown sk.sk /home/sk/.bashrc

# as sk
. /home/sk/.bashrc
echo $VO


# get user key and cert

cp /home/sk/user.crt  /home/sk/.xos/truststore/certs/user.crt
cp /home/sk/user.key  /home/sk/.xos/truststore/private/user.key
cp /home/sk/user.key  /home/sk/.xos/user.key
openssl verify -CApath /etc/xos/truststore/certs/ /home/sk/.xos/truststore/certs/user.crt
echo $VO

as root

xos-policy-admin-am -vo $VO  --force
xos-policy-admin-gm -vo $VO  --force
xos-policy-admin-chk -pem /home/sk/.xos/truststore/certs/user.crt


service sshd-xos restart


openssl verify -CApath /etc/xos/truststore/certs/ /home/sk/.xos/truststore/certs/user.crt
pam_app_conv -pem /home/sk/.xos/truststore/certs/user.crt 


cat > /home/sk/.ssh/config-xos.modele <<EOF
Host __HOST__
  XosProxyFile /home/sk/.xos/truststore/certs/user.crt
  XosVoName   test
EOF

HOST=`hostname`

sed "s/__HOST__/$HOST/g" /home/sk/.ssh/config-xos.modele  > /home/sk/.ssh/config-xos
cat /home/sk/.ssh/config-xos

#must remove w from group (due to umask?)
chmod g-w /home/sk/.ssh/config-xos

ssh-xos `hostname`



