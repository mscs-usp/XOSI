# as root
volife_run.sh -create-user sk "edf123" "sk" "kortas" "EDF " "sk@edf.fr"
volife_run.sh -approve-user sk
volife_run.sh -create-vo test "test" sk
volife_run.sh -list-all-vos | awk '/test/ { gsub(","," "); gsub("gvid","VO");print $4}' >> /home/sk/.bashrc
chown sk.sk /home/sk/.bashrc

# as sk
. /home/sk/.bashrc
echo $VO


# get user key and cert

cp /home/sk/user.crt  /home/sk/.xos/truststore/certs/user.crt
cp /home/sk/user.key  /home/sk/.xos/truststore/private/user.key
cp /home/sk/user.key  /home/sk/.xos/user.key
openssl verify -CApath /etc/xos/truststore/certs/ /home/sk/.xos/truststore/certs/user.crt
echo $VO

as root

xos-policy-admin-am -vo $VO  --force
xos-policy-admin-gm -vo $VO  --force
xos-policy-admin-chk -pem /home/sk/.xos/truststore/certs/user.crt


service sshd-xos restart


openssl verify -CApath /etc/xos/truststore/certs/ /home/sk/.xos/truststore/certs/user.crt
pam_app_conv -pem /home/sk/.xos/truststore/certs/user.crt 


cat > /home/sk/.ssh/config-xos.modele <<EOF
Host __HOST__
  XosProxyFile /home/sk/.xos/truststore/certs/user.crt
  XosVoName   test
EOF

HOST=`hostname`

sed "s/__HOST__/$HOST/g" /home/sk/.ssh/config-xos.modele  > /home/sk/.ssh/config-xos
cat /home/sk/.ssh/config-xos

#must remove w from group (due to umask?)
chmod g-w /home/sk/.ssh/config-xos







ssh-xos `hostname`


pam_app_conv -pem /home/sk/.xos/truststore/certs/user.crt 


as root

rca_list_registered
RES=`rca_list_registered | awk '/Listing/ {next;} { gsub("ResourceID = .IP=",""); gsub("60000.*$","60000"); print $0}' `
echo $VO, $RES
rca_vo l $VO
rca_vo a $VO $RES
rca_vo l $VO
ADD=`rca_vo l $VO`
echo $ADD
!!!!!!!! gaffe a ce que ADD soit une seule ressource!!!

rca_resource_vo a $ADD
ls /etc/xos/truststore/certs/incoming/*crt 
cp  /etc/xos/truststore/certs/incoming/*crt /etc/xos/truststore/certs
xreservation -qf
su - sk
git clone ssh://skortas@paramount/home/orsay/skortas/XOST
cd /home/sk/XOST/AEM
xsub -f job_nu.jsdl 
xps -a


xreservation -qf
git clone ssh://skortas@frontend/home/skortas/XOST
cd /home/sk/XOST/AEM
xsub -f job_nu.jsdl 
xps -a
